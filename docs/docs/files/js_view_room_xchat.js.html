<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>js\view\room\xchat.js - umweb-remote</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="umweb-remote" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/chat_panel.html">chat_panel</a></li>
                                <li><a href="../classes/ChatScrolling.html">ChatScrolling</a></li>
                                <li><a href="../classes/g_UserList.html">g_UserList</a></li>
                                <li><a href="../classes/generateEmulationUserData.html">generateEmulationUserData</a></li>
                                <li><a href="../classes/LoginWithOthers.html">LoginWithOthers</a></li>
                                <li><a href="../classes/MarqueeScroll.html">MarqueeScroll</a></li>
                                <li><a href="../classes/message_display.html">message_display</a></li>
                                <li><a href="../classes/persist.html">persist</a></li>
                                <li><a href="../classes/SendGift.html">SendGift</a></li>
                                <li><a href="../classes/SiteCommon.html">SiteCommon</a></li>
                                <li><a href="../classes/todoCode.html">todoCode</a></li>
                                <li><a href="../classes/User.html">User</a></li>
                                <li><a href="../classes/UserIdentity.html">UserIdentity</a></li>
                                <li><a href="../classes/userPopMenuMap.html">userPopMenuMap</a></li>
                                <li><a href="../classes/video_swf.html">video_swf</a></li>
                                <li><a href="../classes/window.SiteCommon.html">window.SiteCommon</a></li>
                                <li><a href="../classes/xchat_swf.html">xchat_swf</a></li>
                                <li><a href="../classes/xMessager.html">xMessager</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/Controller.html">Controller</a></li>
                                <li><a href="../modules/Decorators.html">Decorators</a></li>
                                <li><a href="../modules/Form Objects.html">Form Objects</a></li>
                                <li><a href="../modules/Policy Objects.html">Policy Objects</a></li>
                                <li><a href="../modules/Query Objects.html">Query Objects</a></li>
                                <li><a href="../modules/Service Objects.html">Service Objects</a></li>
                                <li><a href="../modules/SiteCommon.html">SiteCommon</a></li>
                                <li><a href="../modules/Value Objects.html">Value Objects</a></li>
                                <li><a href="../modules/View Objects.html">View Objects</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: js\view\room\xchat.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * Provides chat interaction
 *
 * @module Policy Objects
 * @method CalcRank
 * compare ranks of different users&#x27; order
 */
function calcRank(appdata) {
    var score = 0;
    var numVip = Number(appdata.vip);
    if (Number(appdata.watchman)) {
        score = 1048576 * 7;//0x40000,1&lt;&lt;18
    }
    if (numVip &amp;&amp; numVip &lt; 100) {
        score += numVip * 524288;//0x100000
    }
    if (Number(Number(numVip) &amp;&amp; numVip &gt;= 100)) {
        score += numVip / 100 * 131072;//0x100000
    }
    if (appdata.vip2 &gt; 0) {
        score += 262144;//0x20000,1&lt;&lt;17
    }
    if (uu89pub.isNiceCode(appdata.nicegid)) {
        score += String(appdata.nicegid).length;
    }
    if (appdata.level == 3) {
        score += Number(appdata.level);
    }
    return score;
}
/**
 * Description:
 *
 * @module Policy Objects
 * @class userPopMenuMap
 */
var userPopupMenuMap = {
    anchor: [
        [true, true, true, true, true, true, true],
        [true, true, true, true, true, true, true],
        [true, true, true, true, true, true, false],
        [true, true, true, true, true, true, true],
        [false, false, true, false, false, true, false],
        [false, false, true, false, false, true, false],
        [false, false, true, false, false, true, false],
        [false, false, false, false, false, false, false],
        [false, false, false, false, false, false, false],
        [false, false, false, false, false, false, false]
    ],
    manager: [
        [true, true, true, true, true, true, true],
        [true, true, true, true, true, true, true],
        [true, true, true, true, true, true, false],
        [true, true, true, true, true, true, true],
        [false, false, false, false, false, false, false],
        [false, false, false, false, false, true, false],
        [false, false, false, false, false, true, false],
        [false, false, false, false, false, false, false],
        [false, false, false, false, false, false, false],
        [false, false, false, false, false, false, false]
    ],
    folkWatchman: [
        [true, true, true, true, true, true, true],
        [true, true, true, true, true, true, true],
        [true, true, true, true, true, true, false],
        [true, true, true, true, true, true, true],
        [false, false, false, false, false, false, false],
        [false, true, true, false, false, true, false],
        [false, true, true, false, false, true, false],
        [false, true, true, false, false, false, false],
        [false, true, true, false, false, true, false],
        [false, true, true, false, false, true, false]
    ],
    watchman: [
        [true, true, true, true, true, true, true],
        [true, true, true, true, true, true, true],
        [true, true, true, true, true, true, false],
        [true, true, true, true, true, true, true],
        [false, false, false, false, false, false, false],
        [false, true, true, true, false, true, false],
        [false, true, true, true, false, true, false],
        [false, true, false, false, false, false, false],
        [false, true, true, true, false, true, false],
        [false, true, true, true, false, true, false]
    ],
    smallConsumer: [
        [true, true, true, true, true, true, true],
        [true, true, true, true, true, true, true],
        [true, true, true, true, true, true, false],
        [true, true, true, true, true, true, true],
        [false, false, false, false, false, false, false],
        [false, false, false, false, false, false, false],
        [false, false, false, false, false, false, false],
        [false, false, false, false, false, false, false],
        [false, false, false, false, false, false, false],
        [false, false, false, false, false, false, false]
    ],
    tourist: [
        [true, true, true, true, true, true, true],
        [true, true, true, true, true, true, true],
        [true, true, true, true, true, true, true],
        [true, true, true, true, true, true, true],
        [false, false, false, false, false, false, false],
        [false, false, false, false, false, false, false],
        [false, false, false, false, false, false, false],
        [false, false, false, false, false, false, false],
        [false, false, false, false, false, false, false],
        [false, false, false, false, false, false, false]
    ]
}
/**
 * Description: Rendering users list
 *
 * @class User
 * @static
 * @param {Number} uid {Number} level {Object} appdata
 * @example
 *  var user = new User(32035941,4,{...});
 *
 */
function User(uid, level, appdata) {
    this.uid = uid;
    this.level = level;
    this.init_level = level;
    this.appdata = appdata;
    this.rank = calcRank(appdata);
}
/**
 * Description:
 *
 * @module View Objects
 * @class User
 * @constructor
 */
User.prototype = {
    hint: function () {
        //return this.appdata.nickname;
        var s;
        s = &#x27;&lt;li&#x27;;
        if (uu89pub.isNiceCode(this.appdata.nicegid)) {
            s += &#x27; class=&quot;lianghao&quot;&#x27;;
        }
        s += &#x27;&gt;&lt;div class=&quot;lvlName&quot;&gt;&lt;span&gt;&#x27; + this.appdata.nickname + &#x27;&lt;/span&gt;&lt;i&gt;(&#x27; + this.appdata.nicegid + &#x27;)&#x27;;
        if (uu89pub.isNiceCode(this.appdata.nicegid)) {
            s += uu89pub.getNiceCodeIcon();
        }
        s += &#x27;&lt;/i&gt;&lt;/div&gt;&#x27;;
        s += &#x27;&lt;div class=&quot;lmlInfor&quot;&gt;&#x27;;
        return uu89pub.getIconStr.call(uu89pub, this.appdata, s, &#x27;&lt;/div&gt;&lt;/li&gt;&#x27;);
    },
    IsAdmin: function () {
        var obj = {
            level: this.level
        }
        return UserIdentity.isManager(obj) || UserIdentity.isWatchman(obj) || UserIdentity.isAnchor(obj)
    },
    Selected: function () {
        if ($(&quot;#message_to option[value=&#x27;&quot; + this.uid + &quot;&#x27;]&quot;).length === 0) {
            $(&quot;#message_to&quot;).append(new Option(this.appdata.nickname, this.uid))
        }
        $(&quot;#message_to&quot;).val(this.uid);
        g_UserList.UserSelected(this.uid);
    },
    isRoomManager: function (level) {
        return this.IsAdmin() || UserIdentity.isAnchor({level: level});
    },
    AddToMemberListUI: function (before_user, level) {
        var CB_Para = this;
        var element = $(&quot;&lt;li&gt;&quot;).attr({
            &#x27;class&#x27;: &#x27;J_user &#x27;, id: this.uid
        }).data(&#x27;level&#x27;, level).append(this.hint()).click(function (e) {
            var cb_para = CB_Para;
            cb_para.DisplayMenu(cb_para, e.pageX, e.pageY);
        });
        if (before_user != null) {
            $(&quot;#&quot; + before_user.uid).before(element);
        } else {
            var room_member_list = &#x27;#con_th_1&#x27;;
            $(room_member_list).append(element);
        }
    },
    getUserIdentity: function (data) {
        if (!Object.keys) {
            Object.keys = function (obj) {
                var keys = [];
                for (var i in obj) {
                    if (obj.hasOwnProperty(i)) {
                        keys.push(i);
                    }
                }
                return keys;
            };
        }
        var arr = Object.keys(UserIdentity)
        var identity = &#x27;&#x27;, index = 0, isMe = false
        $.each(arr, function (i, n) {
            if (UserIdentity[n](data)) {
                if (i == 0) {
                    isMe = true
                } else {
                    identity = n
                    index = i
                    return false
                }
            }
        })
        return {
            identity: identity,
            index: index,
            isMe: isMe
        }
    },
    showAuthorityMenu: function (data) {
        var $JMenu = $(&#x27;.J_menu&#x27;);
        var $JMenuA = $JMenu.find(&#x27;a&#x27;);
        $JMenuA.hide()
        //userpara.level=5
        var pagerOwnerIdentity = this.getUserIdentity(userpara);
        var clickedUserIdentity = this.getUserIdentity(data)
        var arr = Object.keys(userPopupMenuMap)
        var curGroup = arr[pagerOwnerIdentity.index - 1]
        var curLogic = userPopupMenuMap[curGroup]
        var columnIndex = clickedUserIdentity.isMe ? 0 : clickedUserIdentity.index;
        $.each(curLogic, function (i, n) {
            if (i == 3) {// not display folk watchman
                return
            }
            if (n[columnIndex]) {
                var menuItem = $JMenuA.eq(i);
                if (i == 4) {//manger text display
                    if (clickedUserIdentity.index == 2) {
                        menuItem.text(&#x27;取消管理&#x27;)
                    } else {
                        menuItem.text(&#x27;加管理&#x27;)
                    }
                }
                menuItem.css(&#x27;display&#x27;, &#x27;inline-block&#x27;)
            }
        })
    },
    DisplayMenu: function (para, x, y) {
        g_UserList.menu_selected_uid = para.uid;
        this.ControlMenuItem(para);
        var userMenu = $(&quot;.userMenu&quot;);
        var info = &#x27;&lt;h2&gt;&lt;stro&#x27; +
            &#x27;ng&gt;&#x27; + para.appdata.nickname + &#x27;&lt;/strong&gt;&lt;span&gt;&#x27; +
            uu89pub.getCodeStr(para.appdata) +
            &#x27;&lt;/span&gt;&lt;/h2&gt;&#x27;;
        info += uu89pub.getIconStr.call(uu89pub, para.appdata, &#x27;&lt;p&gt;&#x27;, &#x27;&lt;/p&gt;&#x27;);
        info += &#x27;&lt;/p&gt;&lt;span class=&quot;umInforCorner&quot;&gt;&lt;/span&gt;&#x27;;
        $(&quot;.umInfor&quot;).html(info);
        viewHeight = $(window).height();
        $(userMenu).css({&quot;display&quot;: &quot;block&quot;, &quot;left&quot;: x + 10, &quot;top&quot;: y + 10});
        this.showAuthorityMenu(para.appdata);
        if (y + 10 &lt; viewHeight) {
            $(userMenu).css({&quot;left&quot;: x + 10, &quot;top&quot;: y + 10});
        } else {
            $(userMenu).css({&quot;left&quot;: x + 10, &quot;top&quot;: 315});
        }
    },
    ControlMenuItem: function (para) {
        var ADMIN_LEVEL = 900;
        if (xMessager.level == 2000) {
            if (xMessager.uid != para.uid) {
                if (para.level == ADMIN_LEVEL) {
                    $(&#x27;.m_setadmin&#x27;).text(&#x27;把Ta的管理取消&#x27;);
                }
                else {
                    $(&#x27;.m_setadmin&#x27;).text(&#x27;把Ta设置为管理&#x27;);
                }
                this.menu_id = &#x27;#MemberMenu_Roomer&#x27;;
            }
            else {
                this.menu_id = &#x27;#MemberMenu&#x27;;
            }
            return;
        }
        if (xMessager.level &lt; ADMIN_LEVEL) {
            this.menu_id = &#x27;#MemberMenu&#x27;;
            return;
        }
        if (xMessager.level &gt;= ADMIN_LEVEL &amp;&amp; xMessager.level &gt; para.level) {
            this.menu_id = &#x27;#MemberMenu_Admin&#x27;;
        }
        else {
            this.menu_id = &#x27;#MemberMenu&#x27;;
        }
    },
    RemoveFromListUI: function () {
        var uid = this.uid;
        $(&quot;#&quot; + uid).remove();
        $(&quot;#a_&quot; + uid).remove();
        $.each($(&#x27;#message_to option&#x27;), function (i, n) {
            if ($(n).val() == uid) {
                $(n).remove()
                return false
            }
        })
    }
};
function chat_zone_display_user_memu(type, x, y, uid) {
    //alert(type+&#x27;,&#x27;+x+&#x27;,&#x27;+y+&#x27;,&#x27;+uid);
    var u = g_UserList.GetUser(uid);
    //$(this).click(function(event){
    if (u) {
        u.DisplayMenu(u, x, y);
    }
}
/**
 * @description handling user popup panel
 * @class chat_panel
 * */
var chat_panel = {
    menu_flag: 0,
    init: function () {
        $(&quot;#message_btn&quot;).click(function (event) {
            sendChatToSwf($(&quot;#message_input&quot;));
        });
        $(&quot;#message_to&quot;).change(function () {
            g_UserList.UserSelected(parseInt($(this).val()));
        });
        function sendChatToSwf($ele) {
            xMessager.message($ele.val(), Number($(&quot;#secret_check&quot;).is(&#x27;:checked&#x27;)));
            $ele.val(&quot;&quot;);
        }

        SiteCommon.setChatDialog($(&quot;#message_input&quot;), function ($ele) {
            sendChatToSwf($ele);
        });
        $(&quot;#m_gift&quot;).click(function (event) {
            chat_panel.set_gift_target();
            chat_panel.HideMenu();
        });
        $(&quot;#m_chat&quot;).click(function (event) {
            chat_panel.selected(false);
            chat_panel.HideMenu();
        });
        $(&quot;#m_chat_p&quot;).click(function (event) {
            chat_panel.selected(true);
            chat_panel.HideMenu();
        });
        $(&quot;#m_freeflower&quot;).unbind(&#x27;click&#x27;).click(function (event) {
            xMessager.freeflower();
            chat_panel.HideMenu();
        });
        /**
         * Description: bind disabling chat item click event
         *
         * @event
         */
        $(&quot;#m_disable_chat&quot;).unbind(&#x27;click&#x27;).click(function () {
            xMessager.disablechat();
            chat_panel.HideMenu();
        });
        $(&quot;#m_kick&quot;).unbind(&#x27;click&#x27;).click(function (event) {
            xMessager.kickout();
            chat_panel.HideMenu();
        });
        $(&quot;#m_setadmin&quot;).unbind(&#x27;click&#x27;).click(function (event) {
            xMessager.setAdmin();
            chat_panel.HideMenu();
        });
        $(&quot;.m_close&quot;).click(function (event) {
            chat_panel.HideMenu();
        });
    },
    HideMenu: function () {
        $(&quot;.userMenu&quot;).hide();
        //$(&quot;#MemberMenu_Admin&quot;).hide();
        //$(&quot;#MemberMenu_Roomer&quot;).hide();
    },
    set_menu_flag: function (flag) {
        var d = new Date();
        this.menu_flag = flag;
    },
    get_menu_flag: function () {
        return this.menu_flag;
    },
    selected: function (secret) {
        var uid = g_UserList.menu_selected_uid;
        var u = g_UserList.GetUser(uid);
        if (!u) {
            return;
        }
        if ($(&quot;#message_to option[value=&#x27;&quot; + uid + &quot;&#x27;]&quot;).length == 0) {
            //$(&quot;#message_to&quot;).append(new Option(u.appdata.nickname,uid));
            var objOption = document.createElement(&quot;OPTION&quot;);
            objOption.text = u.appdata.nickname;
            objOption.value = uid;
            document.getElementById(&quot;message_to&quot;).options.add(objOption);
        }
        $(&quot;#message_to&quot;).val(uid);
        if (secret) {
            $(&quot;#secret_check&quot;).prop(&quot;checked&quot;, true);
        }
        else {
            $(&quot;#secret_check&quot;).prop(&quot;checked&quot;, false);
        }
        g_UserList.UserSelected(uid);
    },
    set_gift_target: function () {
        var uid = g_UserList.menu_selected_uid;
        var u = g_UserList.GetUser(uid)
        if (u) {
            SetGiftRX(uid, u.appdata.nickname);
        }
    }
};
Array.prototype.insert = function (index, item) {
    this.splice(index, 0, item);
};
Array.prototype.remove = function (from, to) {
    var rest = this.slice((to || from) + 1 || this.length);
    this.length = from &lt; 0 ? this.length + from : from;
    return this.push.apply(this, rest);
};
/**
 * Description: Controlling business logic of users
 *
 * @class g_UserList
 * @static
 */
var g_UserList = {
    members: {},
    member_ui_array: [],
    selected_uid: 0,
    menu_selected_uid: 0,
    admin_count: 0,
    GetUser: function (userInfo, field) {
        if (typeof userInfo === &#x27;string&#x27; || typeof userInfo === &#x27;number&#x27;) {
            if (userInfo in this.members) {
                return this.members[userInfo];
            }
            return null;
        } else {
            var info = userInfo[field];
            return {
                appdata: info
            }
        }
    },
    GetSelectedUser: function () {
        if (this.selected_uid == 0) {
            return null;
        }
        return this.members[this.selected_uid];
    },
    UserSelected: function (uid) {
        this.selected_uid = uid;
        if ($(&#x27;#message_to&#x27;).val() == 0) {
            $(&#x27;#secret_check&#x27;).attr(&#x27;disabled&#x27;, &#x27;disabled&#x27;).removeAttr(&#x27;checked&#x27;)
        } else {
            $(&#x27;#secret_check&#x27;).removeAttr(&#x27;disabled&#x27;)
        }
    },
    isDominated: function (curUserData, newUserData) {
        //todo to modify or del when CalcRank method not effect
        var toBeInsert = false
        // anchor first
        if (UserIdentity.isAnchor(curUserData.appdata)) {
            toBeInsert = false
        } else if (UserIdentity.isAnchor(newUserData) ||
            newUserData.watchman &gt; 0 ||//    is watchman
            newUserData.vip &gt; curUserData.vip ||//peerage
            newUserData.rank &gt; curUserData.rank
            || (newUserData.rank == curUserData.rank &amp;&amp; newUserData.nicegid &lt; curUserData.appdata.nicegid)// nice code comparation
        ) {
            toBeInsert = true
        }
        return toBeInsert;
    },
    UserIn: function (user) {
        this.members[user.uid] = user;
        var before_u = null;
        var arrayLength = this.member_ui_array.length;
        for (var i = 0; i &lt; arrayLength; i++) {
            var curUserData = this.member_ui_array[i];
            var newUserData = user.appdata;
            newUserData.rank = user.rank
            var toBeInsert = this.isDominated(curUserData, newUserData);
            if (toBeInsert) {
                before_u = curUserData;
                this.member_ui_array.insert(i, user);
                break;
            }
        }
        user.AddToMemberListUI(before_u, user.level);
        if (before_u == null) {
            this.member_ui_array.push(user);
        }
        $(&#x27;#user_count&#x27;).html(&#x27;(&#x27; + this.member_ui_array.length + &#x27;)&#x27;);
        if (user.IsAdmin()) {
            this.admin_count += 1;
            $(&#x27;#admin_count&#x27;).html(&#x27;(&#x27; + this.admin_count + &#x27;)&#x27;);
        }
    },
    UserOut: function (uid) {
        if (this.members[uid] == null) {
            return;
        }
        this.members[uid].RemoveFromListUI();
        var arrayLength = this.member_ui_array.length;
        for (var i = 0; i &lt; arrayLength; i++) {
            var u = this.member_ui_array[i];
            if (uid == u.uid) {
                this.member_ui_array.remove(i);
                break;
            }
        }
        if (this.members[uid].IsAdmin()) {
            this.admin_count -= 1;
            $(&#x27;#admin_count&#x27;).html(&#x27;(&#x27; + this.admin_count + &#x27;)&#x27;);
        }
        delete this.members[uid];
        $(&#x27;#user_count&#x27;).html(&#x27;(&#x27; + this.member_ui_array.length + &#x27;)&#x27;);
    },
    ChangeLevel: function (uid, level) {
        if (this.members[uid] == null) {
            return;
        }
        this.members[uid].level = level;
        //this.members[uid].RefeshUI();
    },
    Clear: function () {
        for (var uid in this.members) {
            this.UserOut(uid);
        }
        this.members = {};
        this.member_ui_array = [];
    }
};
/**
 * Description: communication with server when chatting
 *
 * @class persist
 * @deprecated Use xchat_swf.disablechat
 * instead
 */
var persist = {
    url: &#x27;&#x27;,
    alertOperationState: function (result) {
        var r = result;
        if (r.result == 1) {
            alert(&#x27;操作失败&#x27;);
        } else if (r.result == 0) {
            alert(&#x27;操作成功！&#x27;);
        }
    },
    doit: function (type, room_id, touid) {
        var data = {
            &#x27;type&#x27;: type,
            &#x27;uid&#x27;: touid,
            &#x27;room_id&#x27;: room_id
        };
        $.post(this.url, data, function (result) {
            this.alertOperationState(result);
        })
            .fail(function () {
                alert(&#x27;操作发生错误！&#x27;);
            });
    },
    fav: function (room_id) {
        this.doit(10, room_id, 0);
    },
    disablechat: function (room_id, touid) {
        this.url = &#x27;/room/disableChat&#x27;;
        this.doit(5, room_id, touid);
    },
    kickout: function (room_id, touid) {
        this.url = &#x27;/room/kickOut&#x27;;
        this.doit(3, room_id, touid);
    },
    setadmin: function (room_id, touid, be_admin) {
        this.url = &#x27;/room/setAdmin&#x27;;
        if (be_admin) {
            this.doit(1, room_id, touid);
        }
        else {
            this.doit(0, room_id, touid);
        }
    }
};
/**
 * handle chat messages
 * @class xMessager
 * */
var xMessager = {
    logined: false,
    room_id: 0,
    uid: 0,
    level: 0,
    param: {},
    nickname: &#x27;&#x27;,
    chatdisable: 0,
    init: function (param) {
        this.uid = param.uid;
        this.room_id = param.room_id;
        this.level = param.level;
        this.nickname = param.nickname;
        this.chatdisable = param.chatdisable;
        this.param = param;
        if (this.chatdisable &gt; 0) {
            window.setTimeout(function () {
                message_display.prv(&#x27;&lt;font class=&quot;warning&quot;&gt;你的禁止发言已经解除!&lt;/font&gt;&#x27;);
                xMessager.chatdisable = 0;
            }, this.chatdisable * 60 * 1000);
        }
    },
    SocketError: function () {
        if (!xMessager.logined) {
            //message_display.prv(&#x27;&lt;font class=&quot;warning&quot;&gt;连接服务器失败！&lt;/font&gt;&#x27;);
        }
        else {
            //message_display.prv(&#x27;&lt;font class=&quot;warning&quot;&gt;与服务器的连接断开了，请重新登入房间！&lt;/font&gt;&#x27;);
        }
        message_display.prv(&#x27;&lt;font class=&quot;warning&quot;&gt;玩命加载中，请稍后。。。&lt;/font&gt;&#x27;);
        g_UserList.Clear();
        //xchat_start();
    },
    OnChat: function (chatdata) {
        var is_my_message = false;
        if (chatdata.from_user.uid == this.uid) {
            is_my_message = true;
            chatdata.from_user.nickname = &quot;我&quot;;
            chatdata.is_my = true;
        }
        if (chatdata.to_user.uid == this.uid) {
            is_my_message = true;
            chatdata.to_user.nickname = &quot;我&quot;;
            chatdata.is_my_to = true;
        }
        chatdata.fromu = g_UserList.GetUser(chatdata, &#x27;from_user&#x27;);
        if (!$.isEmptyObject(chatdata.to_user)) {
            chatdata.tou = g_UserList.GetUser(chatdata, &#x27;to_user&#x27;);
        }
        message_display.chat(chatdata, is_my_message);
    },
    OnFreeFlower: function (data) {
        var is_my_message = false;
        if (data.fromwho.uid == this.uid || data.sendwho.uid == this.uid) {
            is_my_message = true;
        }
        message_display.freeflower(data, is_my_message);
    },
    OnGift: function (data) {
        message_display.gift(data);
        gift_center.show_gift(data.type, data.gift_swf, data.sum, data.gift_swf_life, data);
        if (data.from_user.uid == room_owner_uid || data.to_user.uid == room_owner_uid) {
            load_room_data(data.to_user.uid);
        }
    },
    OnSpeaker: function (data) {
        //console.log(&#x27;OnSpeaker&#x27;);
        load_speak_data();
    },
    OnAnchorFans: function (data) {
        //console.log(&#x27;OnAnchorFans&#x27;);
        load_anchor_fans();
    },
    OnBanner: function (data) {
        SiteCommon.marqueeGift.feedMessage(data);
    },
    OnSetAdmin: function (param) {
        if (this.level == 2000) {
            return;
        }
        if (param == 1) {
            message_display.prv(&#x27;&lt;font class=&quot;warning&quot;&gt;你被房主设置为房间管理员了，将重新进入房间改变身份！&lt;/font&gt;&#x27;);
        }
        else {
            message_display.prv(&#x27;&lt;font class=&quot;warning&quot;&gt;你的房间管理员身份被房主取消了，将重新进入房间改变身份！&lt;/font&gt;&#x27;);
        }
        setTimeout(function () {
            location.reload(true);
        }, 5000);
    },
    OnData: function (data) {
        switch (data.type) {
            case &#x27;C&#x27;:
                this.OnChat(data.data);
                break;
            case &#x27;F&#x27;:
                this.OnFreeFlower(data.data);
                break;
            case &#x27;G&#x27;:
                data.data.fromu = data.data.from_user
                data.data.tou = data.data.to_user;
                if (data.data.room_info.room_id == room_id) {
                    this.OnGift(data.data);
                }
                if (data.data.source) {
                    this.OnBanner(data.data);
                }
                break;
            case &#x27;LS&#x27;:
                this.OnSpeaker(data.data);
                break;
            case &#x27;AFANS&#x27;:
                this.OnAnchorFans(data.data);
                break;
            case &#x27;ROOM_SET_ADMIN&#x27;:
                this.OnSetAdmin(data.data);
                break;
        }
    },
    message: function (msg, secret) {
        if (!this.logined) {
            return;
        }
        if (msg == &quot;&quot;) {
            return;
        }
        if (UserIdentity.isTourist(this)) {
            checklogin();
            return;
        }
        if (this.chatdisable &gt; 0) {
            alert(&#x27;你目前处于禁止发言状态，不能发言！&#x27;);
            return;
        }
        var chatdata = {
            to_uid: g_UserList.selected_uid,
            secret: secret,
            message: SiteCommon.encodeSpecialSign(msg)
        };
        var selected_user = g_UserList.GetSelectedUser();
        var data = {
            type: &#x27;C&#x27;,
            data: chatdata
        };
        var to_uid = g_UserList.selected_uid;
        if (!secret) {
            to_uid = 0;
        }
        xchat_swf.send(to_uid, Base64.encode(JSON.stringify(data)));
    },
    freeflower: function () {
        if (this.level &lt; 100) {
            //alert(&#x27;游客不能免费献花！&#x27;);
            checklogin();
            return;
        }
        var my_u = g_UserList.GetUser(this.uid);
        var to_u = g_UserList.GetUser(g_UserList.menu_selected_uid);
        if (my_u &amp;&amp; to_u) {
            var data = {
                type: &#x27;F&#x27;,
                data: {
                    fromwho: {gid: my_u.appdata.gid, nickname: my_u.appdata.nickname},
                    sendwho: {gid: to_u.appdata.gid, nickname: to_u.appdata.nickname}
                }
            }
            xchat_swf.send(0, Base64.encode(JSON.stringify(data)));
        }
    },
    disablechat: function () {
        var mins = 5;
        var from_u = g_UserList.GetUser(this.uid);
        var to_u = g_UserList.GetUser(g_UserList.menu_selected_uid);
        if (Number(to_u.appdata.watchman)) {
            $(&quot;#returnmsg&quot;).html(&#x27;小样，对巡管操作，想造反么。。。&#x27;);
            $(&quot;#tips02Pop .pinkBtn&quot;).removeAttr(&quot;onclick&quot;);
            $(&quot;#tips02Pop .pinkBtn&quot;).click(function () {
                $(&quot;#tips02Pop .popPubClose&quot;)[0].click();
            });
            $(&quot;#tips02&quot;).click();
            return;
        }
        if (to_u.appdata.vip2 &amp;&amp; (!UserIdentity.isAnchor(from_u.appdata) &amp;&amp; !from_u.appdata.watchman)) {
            $(&quot;#returnmsg&quot;).html(&#x27;用户享有&lt;img src=&quot;/images/room/vip/vip.gif&quot; style=&quot;width:27px;height:15px&quot;&gt;，无法操作&#x27;);
            $(&quot;#tips02Pop .pinkBtn&quot;).removeAttr(&quot;onclick&quot;);
            $(&quot;#tips02Pop .pinkBtn&quot;).click(function () {
                $(&quot;#tips02Pop .popPubClose&quot;)[0].click();
            });
            $(&quot;#tips02&quot;).click();
            return;
        }
        if (to_u) {
            //todo to del because xchat_swf.disablechat is responsible to communicate with server
            persist.disablechat(this.room_id, to_u.uid);
            xchat_swf.disablechat(to_u.uid, mins);
        }
    },
    kickout: function () {
        var from_u = g_UserList.GetUser(this.uid);
        var to_u = g_UserList.GetUser(g_UserList.menu_selected_uid);
        if (Number(to_u.appdata.watchman)) {
            $(&quot;#returnmsg&quot;).html(&#x27;小样，对巡管操作，想造反么。。。&#x27;);
            $(&quot;#tips02Pop .pinkBtn&quot;).removeAttr(&quot;onclick&quot;);
            $(&quot;#tips02Pop .pinkBtn&quot;).click(function () {
                $(&quot;#tips02Pop .popPubClose&quot;)[0].click();
            });
            $(&quot;#tips02&quot;).click();
            return;
        }
        if (to_u.appdata.vip2 &amp;&amp; (!from_u.appdata.roomer &amp;&amp; !from_u.appdata.watchman)) {
            $(&quot;#returnmsg&quot;).html(&#x27;用户享有&lt;img src=&quot;/images/room/vip/vip.gif&quot; style=&quot;width:27px;height:15px&quot;&gt;，无法操作&#x27;);
            $(&quot;#tips02Pop .pinkBtn&quot;).removeAttr(&quot;onclick&quot;);
            $(&quot;#tips02Pop .pinkBtn&quot;).click(function () {
                $(&quot;#tips02Pop .popPubClose&quot;)[0].click();
            });
            $(&quot;#tips02&quot;).click();
            return;
        }
        if (to_u) {
            persist.kickout(this.room_id, to_u.uid);
            xchat_swf.kickout(to_u.uid);
        }
    },
    setAdmin: function () {
        var to_u = g_UserList.GetUser(g_UserList.menu_selected_uid);
        if (to_u) {
            var be_admin = (to_u.level != 3 ? 1 : 0);
            //persist.setadmin(this.room_id, to_u.uid, be_admin);
            var data = {
                type: &#x27;ROOM_SET_ADMIN&#x27;,
                data: be_admin,
                to_uid: to_u.uid
            }
            xchat_swf.send(to_u.uid, Base64.encode(JSON.stringify(data)));
        }
    },
    giftmessage: function (type, param, banner) {
        var data = {
            type: &#x27;G&#x27;,
            data: param
        }
        xchat_swf.send(0, Base64.encode(JSON.stringify(data)));
        if (banner == &#x27;B&#x27;) {
            var data = {
                type: &#x27;BANNER&#x27;
            }
            xchat_swf.send(-1, Base64.encode(JSON.stringify(data)));
        }
    },
    speakermessage: function (data) {
        //var data = {
        //    type: &#x27;LS&#x27;,
        //    data: param
        //}
        xchat_swf.broadcast(Base64.encode(JSON.stringify(data)));
    },
    anchorfans: function () {
        var data = {
            type: &#x27;AFANS&#x27;
        }
        xchat_swf.send(0, Base64.encode(JSON.stringify(data)));
    },
    ReEnter: function () {
        message_display.prv(&#x27;&lt;font class=&quot;warning&quot;&gt;你已被同一账号挤出本房间！&lt;/font&gt;&#x27;);
    },
    LoginACK: function (param) {
        if (param.loginack == 0) {
            switch (param.reason) {
                case 2:
                    message_display.prv(&#x27;&lt;font class=&quot;warning&quot;&gt;服务器人数满了！&lt;/font&gt;&#x27;);
                    break;
                case 3:
                    message_display.prv(&#x27;&lt;font class=&quot;warning&quot;&gt;房间人数满了！&lt;/font&gt;&#x27;);
                    break;
            }
        }
    }
};
/**
 * Description: display messages on screen
 *
 * @class message_display
 * @static
 */
var message_display = {
    /**
     * Description: insert
     *
     * @
     * @
     */
    prv: function (msg) {
        uu89prv.insert(msg);
    },
    pub: function (msg) {
        uu89pub.insert(msg);
    },
    chat: function (chatdata, is_my_message) {
        if (is_my_message) {
            uu89prv.display_chatmessage(chatdata);
            if (chatdata.secret == 0) {
                uu89pub.display_chatmessage(chatdata);
            }
        }
        else {
            uu89pub.display_chatmessage(chatdata);
        }
    },
    freeflower: function (data, is_my_message) {
        if (is_my_message) {
            document.getElementById(&#x27;chat_prv&#x27;).contentWindow.FreeFlower(data);
        }
        else {
            document.getElementById(&#x27;chat_pub&#x27;).contentWindow.FreeFlower(data);
        }
    },
    gift: function (data) {
        var is_my_message = false;
        if (data.from_user.uid == userpara.uid || data.to_user.uid == userpara.uid) {
            is_my_message = true;
        }
        uu89pub.disgift(data);
        if (is_my_message) {
            uu89prv.disgift(data);
        }
    }
}
/**
 * Interacting between Js and Flash
 * @class xchat_swf

 * */
var xchat_swf = {
    videoSwf: null,
    /**
     * Init interaction event
     *
     * @method Init
     * @return {Undefined}
     * @example
     *    xchat_swf.Init(xconf_swf_param,&#x27;xchat&#x27;,null);
     * */
    Init: function (swf_param, div_id, callbackFn) {
        if (callbackFn == null) {
            callbackFn = this.Created_cb;
        }
        var swfVersionStr = &quot;11.0.0&quot;;
        // To use express install, set to playerProductInstall.swf, otherwise the empty string.
        var xiSwfUrlStr = &quot;playerProductInstall.swf&quot;;
        var flashvars = {};
        flashvars = {
            ip: swf_param.ip,
            port: swf_param.port,
            gid: swf_param.room_id,
            uid: swf_param.uid,
            source:0,
            userToken: readcookie(&quot;umei_token&quot;)
        };
        var params = {};
        params.quality = &quot;high&quot;;
        params.bgcolor = &quot;#57799c&quot;;
        params.allowscriptaccess = &quot;always&quot;;
        params.allowfullscreen = &quot;true&quot;;
        params.wmode = &quot;transparent&quot;;
        var attributes = {};
        attributes.id = &quot;xchat&quot;;
        attributes.name = &quot;xchat&quot;;
        attributes.align = &quot;middle&quot;;
        attributes.wmode = &#x27;transparent&#x27;
        /**
         * Description: embed swf in doc, ref: https://code.google.com/p/swfobject/wiki/documentation
         *
         * @method swfobject.embedSWF
         */
        var dir = SiteCommon.SWF_DIR;
        var swfmame = dir +
            &quot;new_xchat.swf&quot;;
        swfobject.embedSWF(
            swfmame, div_id,
            $(&quot;#&quot; + div_id).width(), $(&quot;#&quot; + div_id).height(),
            swfVersionStr, xiSwfUrlStr,
            flashvars, params, attributes, callbackFn);
        // JavaScript enabled so display the flashContent div in case it is not replaced with a swf object.
        //swfobject.createCSS(&quot;#flashContent&quot;, &quot;display:block;text-align:center;&quot;);
    },
    alertNoSwf: function () {
        alert(&quot;flash初始化失败.&quot;);
    },
    Created_cb: function (cbobj) {
        if (cbobj.success) {
        }
        else {
            xchat_swf.alertNoSwf();
        }
    },
    swf: function () {
        var swf = this.videoSwf;
        return swf ? swf : (this.videoSwf = swfobject.getObjectById(&quot;xchat&quot;))
    },
    send: function (to_uid, data) {
        try {
            this.swf().Chat(to_uid, data);
        } catch (e) {
            alert(&#x27;房间出现故障&#x27;)
        }
    },
    disablechat: function (touid, mins) {
        this.swf().DisableChat(touid, mins);
    },
    broadcast: function (dataStr) {
        this.swf().broadcast(dataStr);
    },
    kickout: function (touid) {
        this.swf().Kickout(touid);
    },
    setRoomInfo: function (type, data) {
        this.swf().setRoomInfo(type, data);
    },
    /**
     * Description: prompting when broadcast ends
     *
     * @deprecated Use xchat_swf_message
     * instead
     */
    tokenop: function (type) {
        if (type == &#x27;0&#x27;) {
            this.swf().TokenOp(0);
            $(&#x27;#live_time&#x27;).html(&#x27;开播时间：直播未开始&#x27;);
        }
        if (type == &#x27;1&#x27;) {
            this.swf().TokenOp(1);
            var currentdate = new Date();
            var datetime = currentdate.getHours() + &quot;:&quot; + currentdate.getMinutes();
            $(&#x27;#live_time&#x27;).html(&#x27;开播时间：&#x27; + datetime);
        }
    }
};
function xchat_swf_debug(info) {
}
function xchat_swf_error(Error) {
    xMessager.SocketError();
}
function member_in_out_hint(appdata, type) {
    appdata.type = type;
    uu89pub.disinout(appdata);
}
function handleKickoutState() {
    var kickoutTotalTime = 15;
    var kickoutDuration = Math.ceil(roompara.kickout / 60);
    message_display.prv(&#x27;&lt;font class=&quot;warning&quot;&gt;你被管理员踢出了！&#x27; +
    kickoutTotalTime +
    &#x27;分钟内不允许进入本房间！&lt;/font&gt;&#x27;);
    $(&quot;.liveVideo, .noliveVideo&quot;).remove();
    $(&quot;.J_kickoutVideo&quot;).show();
    $(&#x27;.J_countdown&#x27;).text(kickoutDuration == 0 ? kickoutTotalTime : kickoutDuration)
    SiteCommon.recursiveUnbind($(&#x27;body&#x27;));
    function changeMinute() {
        $(&#x27;.J_countdown&#x27;).text(function (i, n) {
            var num = parseInt(n)
            if (num == 0) {
                clearInterval(countdown)
                location.reload()
            } else {
                return --num
            }
        })
    }

    var countdown = setInterval(function () {
        changeMinute();
    }, 1000 * 60)
}
function displayForbiddenState(param) {
    if (param.uid == xMessager.uid) {
        handleKickoutState();
    }
    else {
        var u = g_UserList.GetUser(param.uid);
        if (u) {
            var s = &#x27;&lt;font class=&quot;warning&quot;&gt;【&#x27; + u.appdata.nickname + &#x27;(&#x27; + u.appdata.uid + &quot;)】被管理员踢出房间了。15分钟内不允许进入本房间。&lt;/font&gt;&quot;;
            message_display.pub(s);
        }
    }
}
/**
 * Description: called by Flash
 *
 * @method xchat_swf_message_new
 * @param pid {Number}
 * @param param {Object}
 * @example
 *  xchat_swf_message_new(0,{&quot;data&quot;:{&quot;nickname&quot;:&quot;qcgm1978&quot;,&quot;touid&quot;:0,&quot;to_nickname&quot;:&quot;所有人&quot;,&quot;secret&quot;:false,&quot;message&quot;:&quot;a&quot;,&quot;uid&quot;:32087767},&quot;type&quot;:&quot;C&quot;})
 */
function xchat_swf_message_new(pid, param) {
    switch (pid) {
        case 121:
            if (param.result == 0) {
                message_display.prv(&#x27;连接服务器成功.&#x27;);
                message_display.prv(&#x27;&lt;font color=&quot;#FF4444&quot;&gt;主播欢迎你:&lt;/font&gt;&#x27; + room_welcome + &#x27;&#x27;);
                xMessager.logined = true;
                xMessager.uid = param.uid;
            } else if (param.result == 4) {
                handleKickoutState();
            }
            break;
        case 122:
            var user;
            param.gid = param.room_id;
            if (param.in_out_hint) {
                user = new User(param.uid, param.level, param);
                g_UserList.UserIn(user);
                if (parseInt(param.car_id) &gt; 0) {
                    showcar(param);
                } else {
                    member_in_out_hint(param, 1);
                }
            } else {
                user = g_UserList.GetUser(param.uid)
                if (user) {
                    member_in_out_hint(param, 0);
                }
                g_UserList.UserOut(param.uid);
            }
            break;
        case 123:
            if (isTestEnvironment()) {
                generateEmulationUserData(param)
            } else {
                var user = new User(param.uid, param.level, param);
                g_UserList.UserIn(user);
            }
            break;
        case 132:
            xMessager.OnData({&quot;type&quot;: &quot;C&quot;, &quot;data&quot;: param});
            break;
        case 142:
            xMessager.OnData({&quot;type&quot;: &quot;G&quot;, &quot;data&quot;: param});
            break;
        case 151:
            persist.alertOperationState(param)
            break;
        case 152:
            xMessager.OnData({&quot;type&quot;: &quot;ROOM_SET_ADMIN&quot;, &quot;data&quot;: param});
            break;
        case 161:
            break;
        case 162:
            if (param.to_user.uid == xMessager.uid) {
                if (param.chatenable) {
                    message_display.prv(&#x27;&lt;font class=&quot;warning&quot;&gt;你的禁止发言已经解除!&lt;/font&gt;&#x27;);
                    xMessager.chatdisable = 0;
                }
                else {
                    message_display.prv(&#x27;&lt;font class=&quot;warning&quot;&gt;你被管理员禁止发言5分钟!&lt;/font&gt;&#x27;);
                    xMessager.chatdisable = 1;
                }
            }
            else {
                var u = g_UserList.GetUser(param.to_user.uid);
                if (u) {
                    if (!param.chatenable) {
                        var s = &#x27;&lt;font class=&quot;warning&quot;&gt;【&#x27; + uu89pub.getUserNameEle(u.appdata) + &quot;】被管理员禁止发言5分钟!&lt;/font&gt;&quot;;
                        message_display.pub(s);
                    }
                }
            }
            break;
        case 171:
            break;
        case 172:
            displayForbiddenState(param);
            break;
        case 182 :
            if (param.tokenid == 1) {
                if (param.tokenstatus == 1) {
                    if ($(&#x27;#live_time&#x27;).html() == &#x27;开播时间：直播未开始&#x27;) {
                        var currentdate = new Date();
                        var datetime = currentdate.getHours() + &quot;:&quot; + currentdate.getMinutes();
                        $(&#x27;#live_time&#x27;).html(&#x27;开播时间：&#x27; + datetime);
                    }
                    $(&quot;.noliveVideo&quot;).show();
                    $(&quot;.liveVideo&quot;).hide();
                    setTimeout(function () {
                        video_swf.LiveState(1);
                    }, 1000)
                }
                else {
                    $(&#x27;#live_time&#x27;).html(&#x27;开播时间：直播未开始&#x27;);
                    video_swf.LiveState(0);
                    if (!UserIdentity.isAnchor(userpara)) {
                        load_room_recommended();
                        $(&quot;.noliveVideo&quot;).hide();
                        $(&quot;.liveVideo&quot;).show();
                    }
                }
            }
            break;
        case 192 :
            video_swf.webSetLive(param.state)
            break;
        case 221:
            setFollowBtn(param)
            break;
        case 222:
            setFansVal(param);
            break;
        //broadcast response
        case 231:
            break;
        //broadcast distributed
        case 232:
            if (param.type == 1) {
                var strVar = SiteCommon.generateBroadItem({
                    name: param.from_user.nickname,
                    uid: param.gid,
                    message: param.message
                });
                SiteCommon.marqueeBroad.feedMessage(strVar)
                if ($(&quot;.radioWord&quot;).is(&#x27;:visible&#x27;)) {
                    SiteCommon.radioFn();
                }
            }
            break;
    }
}
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
